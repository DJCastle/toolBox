name: Lint

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  shellcheck:
    name: ShellCheck (.sh)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install ShellCheck
        run: sudo apt-get install -y shellcheck
      - name: Run ShellCheck
        run: |
          find . -name '*.sh' -not -path './.git/*' -print0 | \
            xargs -0 shellcheck --severity=warning

  psscriptanalyzer:
    name: PSScriptAnalyzer (.ps1)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install PSScriptAnalyzer
        shell: pwsh
        run: Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser
      - name: Run PSScriptAnalyzer
        shell: pwsh
        run: |
          $results = Get-ChildItem -Recurse -Filter '*.ps1' |
            ForEach-Object {
              Invoke-ScriptAnalyzer -Path $_.FullName -Severity Warning -ExcludeRule PSAvoidUsingWriteHost
            }
          if ($results) {
            $results | Format-Table -AutoSize
            exit 1
          }
